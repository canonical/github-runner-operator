#!/bin/sh

set -e

# Write .env contents
su - ubuntu -c 'cd ~/actions-runner && echo "{{ env_contents }}" > .env'

{% if aproxy_address %}
snap install aproxy --edge
snap set aproxy proxy={{ aproxy_address }} listen=:54969
cat << EOF > /etc/nftables.conf
define default-ip = $(ip route get $(ip route show 0.0.0.0/0 | grep -oP 'via \K\S+') | grep -oP 'src \K\S+')
define private-ips = { 10.0.0.0/8, 127.0.0.1/8, 172.16.0.0/12, 192.168.0.0/16 }
table ip aproxy
flush table ip aproxy
table ip aproxy {
      chain prerouting {
              type nat hook prerouting priority dstnat; policy accept;
              ip daddr != \$private-ips tcp dport { 80, 443 } counter dnat to \$default-ip:54969
      }

      chain output {
              type nat hook output priority -100; policy accept;
              ip daddr != \$private-ips tcp dport { 80, 443 } counter dnat to \$default-ip:54969
      }
}
EOF
systemctl enable nftables.service
nft -f /etc/nftables.conf
{% endif %}

adduser ubuntu lxd

{% if dockerhub_mirror %}
echo "{\"registry-mirrors\": [\"{{ dockerhub_mirror }}\"]}" > /etc/docker/daemon.json
{% endif %}

# Create the runner and start the configuration experience
{% if runner_group %}
su - ubuntu -c "cd ~/actions-runner && ./config.sh \
    --url {{ github_url }} \
    --runnergroup '{{ runner_group }}' \
    --token {{ token }} --ephemeral --unattended \
    --labels {{ instance_labels }} --name {{ instance_name }}"
{% else %}
su - ubuntu -c "cd ~/actions-runner && ./config.sh \
    --url {{ github_url }} \
    --token {{ token }} --ephemeral --unattended \
    --labels {{ instance_labels }} --name {{ instance_name }}"
{% endif %}

# Run runner
su - ubuntu -c "cd ~/actions-runner && /home/ubuntu/actions-runner/run.sh"

su - ubuntu -c "touch /home/ubuntu/run-completed"
